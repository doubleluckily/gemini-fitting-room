# 超时问题排查和解决方案

## 问题原因

错误信息：`context deadline exceeded` 表示请求 Gemini API 超时了。

## 已实施的优化

### 1. 增加超时时间
- 从 5 分钟增加到 **10 分钟**
- 图片处理需要较长时间，特别是多张图片时

### 2. 添加详细日志
现在会显示：
- 任务开始处理
- 图片数量统计（人物、衣服、配饰）
- API 调用开始/完成
- 错误详情

### 3. 更友好的错误提示
超时会显示：`"请求超时：处理时间过长，请尝试减少图片数量或使用更小的图片"`

## 可能的原因和解决方案

### 1. 网络问题
**症状**: API 调用超时

**解决方案**:
```bash
# 配置代理（如果需要）
export HTTP_PROXY=http://127.0.0.1:7890
export HTTPS_PROXY=http://127.0.0.1:7890

# 重新启动服务
go run main.go
```

### 2. API Key 问题
**症状**: API 调用失败

**检查**:
```bash
# 查看 API Key 是否设置
echo $GEMINI_API_KEY

# 如果没有，设置它
export GEMINI_API_KEY="your-api-key-here"
```

### 3. 图片太大或太多
**症状**: 处理时间过长导致超时

**解决方案**:
- 减少图片数量（1-2张衣服图片）
- 压缩图片大小（建议每张 < 1MB）
- 使用简单的模特模板（SVG 很小）

### 4. 使用更快的模型
当前使用 `gemini-2.0-flash-exp`，这是实验性模型，可能不稳定。

可以尝试改用稳定版：
```go
"gemini-2.0-flash-exp"  // 当前（实验性，功能强但可能慢）
// 改为
"gemini-1.5-flash"      // 稳定版（更快）
```

### 5. Gemini API 限流
**症状**: 一开始可以，后面一直超时

**原因**: 免费版 API 有速率限制

**解决方案**:
- 等待几分钟再试
- 升级到付费版
- 减少请求频率

## 监控日志

启动服务后，观察日志输出：

```
[task_xxx] 开始处理任务
[task_xxx] 图片数量: 3 (人物:1, 衣服:1, 配饰:1)
[task_xxx] 开始调用 Gemini API...
[task_xxx] Gemini API 调用完成
[task_xxx] API 调用成功，正在处理结果...
[task_xxx] 任务完成成功
```

如果看到：
```
[task_xxx] 失败: context deadline exceeded
```
说明确实是超时问题。

## 建议的测试步骤

### 第一步：简单测试
只上传 1 张图片（人物或衣服），不传其他图片
- 如果成功 → 说明是图片太多的问题
- 如果失败 → 说明是网络或 API Key 的问题

### 第二步：网络测试
```bash
# 测试能否访问 Google API
curl -I https://generativelanguage.googleapis.com
```

### 第三步：代理测试
如果直连失败，配置代理后重试

## 快速修复建议

### 选项 1: 使用更简单的模型
修改 `main.go` 第 195 行：
```go
"gemini-2.0-flash-exp",  // 改为
"gemini-1.5-flash",      // 更快更稳定
```

### 选项 2: 进一步增加超时
如果 10 分钟还不够，改为 15 分钟：
```go
ctx, cancel := context.WithTimeout(context.Background(), 15*time.Minute)
```

### 选项 3: 添加重试机制
在失败后自动重试 1-2 次

## 当前状态

✅ 超时时间: 10 分钟
✅ 详细日志: 已启用
✅ 错误提示: 已优化
✅ 图片统计: 已添加

运行后查看终端日志，可以获得更详细的错误信息！
